#lang racket/base

(require racket/match
         "ast.rkt")

(provide (all-defined-out))

(struct Fun_t (ret args))
(struct Ptr_t (t) #:transparent)
(struct Struct_t (name fields))

(define pair (Struct_t 'pair (list (cons 'head 'num)
                                   (cons 'tail (Ptr_t 'pair)))))

(define (sizeof t)
  (match t
    ['num      4]
    [(Ptr_t _) 4]
    ['char     1]
    [(Struct_t _ fields)
     (foldl (lambda (acc f) (+ acc (sizeof (cdr f))))
            0 fields)]))

(define (member-offset s m)
  (define (mo-aux fields offset)
    (match fields
      [(? null? _)
       (error "FAIL")]
      [(? (lambda (f) (eq? (caar f) m)) _)
       offset]
      [else
       (mo-aux (cdr fields) (+ offset (sizeof (cdar fields))))]))
  (mo-aux (Struct_t-fields s) 0))

(define *baselib-types*
  (make-immutable-hash
   (list (cons '%add (Fun_t 'num (list 'num 'num)))
         (cons '%sub (Fun_t 'num (list 'num 'num)))
         (cons '%mul (Fun_t 'num (list 'num 'num)))
         (cons '%div (Fun_t 'num (list 'num 'num)))
         (cons '%mod (Fun_t 'num (list 'num 'num)))
         (cons '%seq (Fun_t 'num (list 'num 'num))) ;; -> 'num pour tester
         (cons '%sne (Fun_t 'num (list 'num 'num)))
         (cons '%slt (Fun_t 'num (list 'num 'num)))
         (cons '%sgt (Fun_t 'num (list 'num 'num)))
         (cons '%sle (Fun_t 'num (list 'num 'num)))
         (cons '%sge (Fun_t 'num (list 'num 'num))) ;;
         (cons 'print_num (Fun_t 'void (list 'num)))
         (cons 'print_str (Fun_t 'void (list 'str)))
         (cons 'print_nl  (Fun_t 'void (list)))
         (cons 'nil       (Fun_t (Ptr_t '%) (list)))
         (cons 'pair      (Fun_t (Ptr_t 'pair) (list 'num (Ptr_t 'pair))))
         (cons 'head      (Fun_t 'num (list (Ptr_t 'pair))))
         (cons 'tail      (Fun_t (Ptr_t 'pair) (list (Ptr_t 'pair)))))))

(define *baselib-builtins*
  (make-immutable-hash
   (list (cons '%add (list (Lw 't0 (Mem 'sp 4))
                           (Lw 't1 (Mem 'sp 0))
                           (Add 'v0 't0 't1)))
         (cons '%sub (list (Lw 't0 (Mem 'sp 4))
                           (Lw 't1 (Mem 'sp 0))
                           (Sub 'v0 't0 't1)))
         (cons '%mul (list (Lw 't0 (Mem 'sp 4))
                           (Lw 't1 (Mem 'sp 0))
                           (Mul 'v0 't0 't1)))
         (cons '%div (list (Lw 't0 (Mem 'sp 4))
                           (Lw 't1 (Mem 'sp 0))
                           (Div 'v0 't0 't1)))
         (cons '%mod (list (Lw 't0 (Mem 'sp 4))
                           (Lw 't1 (Mem 'sp 0))
                           (Div 'v0 't0 't1)
                           (Mfhi 'v0)))
         (cons '%seq (list (Lw 't0 (Mem 'sp 4))
                           (Lw 't1 (Mem 'sp 0))
                           (Seq 't9 't0 't1))) ;;/!\ $v0 pour tester /!\
         (cons '%sne (list (Lw 't0 (Mem 'sp 4))
                           (Lw 't1 (Mem 'sp 0))
                           (Sne 't9 't0 't1)))
         (cons '%slt (list (Lw 't0 (Mem 'sp 4))
                           (Lw 't1 (Mem 'sp 0))
                           (Slt 't9 't0 't1)))
         (cons '%sgt (list (Lw 't0 (Mem 'sp 4))
                           (Lw 't1 (Mem 'sp 0))
                           (Sgt 't9 't0 't1)))
         (cons '%sle (list (Lw 't0 (Mem 'sp 4))
                           (Lw 't1 (Mem 'sp 0))
                           (Sle 't9 't0 't1)))
         (cons '%sge (list (Lw 't0 (Mem 'sp 4)) ;;
                           (Lw 't1 (Mem 'sp 0))
                           (Sge 't9 't0 't1)))
         (cons 'print_num (list (Lw 'a0 (Mem 'sp 0))
                                (Li 'v0 PRINT_INT)
                                (Syscall)))
         (cons 'print_str (list (Lw 'a0 (Mem 'sp 0))
                                (Li 'v0 PRINT_STRING)
                                (Syscall)))
         (cons 'print_nl (list (La 'a0 (Lbl 'nl))
                               (Li 'v0 PRINT_STRING)
                               (Syscall)))
         (cons 'nil (list (Li 'v0 0)))
         (cons 'pair (list (Jal (Lbl 'pair))))
         (cons 'head (list (Jal (Lbl 'head))))
         (cons 'tail (list (Jal (Lbl 'tail)))))))

(define *fake-user-code*
  (list (Label 'pair)
        (Addi 'sp 'sp -12)
        (Sw 'ra (Mem 'sp 0))
        (Sw 'fp (Mem 'sp 4))
        (Addi 'fp 'sp 12)
        (Li 'a0 8)
        (Li 'v0 SBRK)
        (Syscall)
        (Sw 'v0 (Mem 'sp 8))
        (Lw 'v0 (Mem 'fp 4))
        (Move 't0 'v0)
        (Lw 'v0 (Mem 'sp 8))
        (Sw 't0 (Mem 'v0 0))
        (Lw 'v0 (Mem 'fp 0))
        (Move 't0 'v0)
        (Lw 'v0 (Mem 'sp 8))
        (Sw 't0 (Mem 'v0 4))
        (Lw 'v0 (Mem 'sp 8))
        (Lw 'ra (Mem 'sp 0))
        (Lw 'fp (Mem 'sp 4))
        (Addi 'sp 'sp 12)
        (Jr 'ra)
        (Label 'head)
        (Addi 'sp 'sp -8)
        (Sw 'ra (Mem 'sp 0))
        (Sw 'fp (Mem 'sp 4))
        (Addi 'fp 'sp 8)
        (Lw 'v0 (Mem 'fp 0))
        (Lw 'v0 (Mem 'v0 0))
        (Lw 'ra (Mem 'sp 0))
        (Lw 'fp (Mem 'sp 4))
        (Addi 'sp 'sp 8)
        (Jr 'ra)
        (Label 'tail)
        (Addi 'sp 'sp -8)
        (Sw 'ra (Mem 'sp 0))
        (Sw 'fp (Mem 'sp 4))
        (Addi 'fp 'sp 8)
        (Lw 'v0 (Mem 'fp 0))
        (Lw 'v0 (Mem 'v0 4))
        (Lw 'ra (Mem 'sp 0))
        (Lw 'fp (Mem 'sp 4))
        (Addi 'sp 'sp 8)
        (Jr 'ra)))
